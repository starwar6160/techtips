v2ray_ws_tls_cdn教程1911

用到的网站地址：
https://www.v2ray.com/	v2ray官网；
https://github.com/wulabing/V2Ray_ws-tls_bash_onekey	一键部署脚本地址
https://www.namesilo.com 域名注册
https://github.com/2dust/v2rayN/releases	v2ray Windows客户端；
https://www.cloudflare.com/zh-cn/	CDN公司
https://amazonaws-china.com/cn/	AWS
https://cloud.google.com/compute/	Google GCE（COMPUTE ENGINE)
https://zhuanlan.zhihu.com/p/52758924 阿里云监控卸载
https://www.livelu.com/201804305.html	CloudFlare IP白名单
https://wq.apnic.net/static/search.html APNIC whois IP归属地查询；
https://apkcombo.com/zh-cn/apk-downloader/	APK Downloader
https://github.com/FelisCatus/SwitchyOmega/wiki/GFWList GFWList使用说明
https://github.com/gfwlist/gfwlist gfwlist官网
https://intmainreturn0.com/v2ray-config-gen/	v2ray配置生成器；
https://justmysocks.net/members/index.php	justmysocks 搬瓦工官方机场

基本配置：国外VPS部署v2ray，使用配置生成器生成一个配置文件，Windows客户端填写各项参数，更改浏览器代理设置到本机的v2ray客户端端口，客户端内部设置“绕过局域网和中国大陆IP”。达到“可用”的效果；优点：配置简便；缺点：抗封锁能力较差，到敏感时期就有较大几率被封。
高级配置：v2ray+ws+tls+cdn+gfwlist。使用一键安装脚本。优点：抗封锁能力强，敏感时期也照常顺利使用，基本一劳永逸。缺点：配置复杂，技能要求高，哪怕有了自动安装脚本，也还要自己购买域名，设置cdn，设置防火墙，设置浏览器gfwlist分流插件等各项工作。


整体原理说明：
v2ray+websocket+tls：是v2ray软件本身支持ws和tls，加上一个nginx作为反向代理，部署完毕后的网站，去用https访问能正常打开一个https网站，这是一个伪装。
翻墙通道是通过websocket，在TLS的保护下，等于是浏览器访问的用户不知道的小道；
目前GFW对于未知加密流量是有罪推定，一般的翻墙软件往往很快就封，但是HTTPS流量太普遍，轻易不会封，所以唯有伪装成HTTPS流量才能比较好的抗封锁；
v2ray在翻墙软件中本来就因为其是一个框架，配置比较繁琐。v2ray+ws+tls配置更是繁琐，还涉及申请TLS证书等繁琐的事，所以有高手写了一个自动化脚本来做这个。
里面有2种方式，我只试验成功了第一种方式，命令行如下：
bash <(curl -L -s https://raw.githubusercontent.com/wulabing/V2Ray_ws-tls_bash_onekey/master/install.sh) | tee v2ray_ins.log
注意，我估计要debian系的系统才行，我习惯Ubuntu 18.04LTS，验证通过，部署了好几台都没问题；
注意，要以root账号执行，最好是新的VPS，没有软件占据80/443这两个端口；
这种方式，ws+tls，要求TLS证书，所以要一个域名，并指向该VPS的IP，请事先买好域名，并创建一个例如aaa.youdomain.top这样的二级域名指向你的VPS的IP，然后该自动安装脚本执行过程中输入这个二级域名，脚本才能用这个二级域名去自动申请TLS证书；
域名注册建议选择namesilo这一家，价格低而且没有续费价格暴涨的等等的套路。https://www.namesilo.com/pricing.php 很便宜的.top域名，1.49美元第一年，以后每年7.19美元续费；需要有一张支持美元的信用卡付款，银联美元双币卡即可；
自动脚本安装完毕后类似如下信息：
[OK]  V2ray+ws+tls 安装成功
 V2ray 配置信息 [OK]  V2ray+ws+tls 安装成功
 V2ray 配置信息
 地址（address）: aaa.youdomain.top
 端口（port）： 443
 用户id（UUID）： 6f009c02-9831-471c-85ee-72eeea8231b8
 额外id（alterId）： 300
 加密方式（security）： 自适应
 传输协议（network）： ws
 伪装类型（type）： none
 路径（不要落下/）： /11559273/
 底层传输安全： tls
[OK]  Nginx 启动 完成
此外还会有一个二维码，请调整SSH窗口字体，使其显示整齐，然后就可以用手机v2ray客户端扫描该二维码了，免得手工输入这么多东西，这些东西手工输入也不太现实；
手机客户端推荐Google Play市场的v2rayNG；可以设定只有部分应用走v2ray的通道，对国产应用不产生影响；
前面的Windows客户端可以自动生成服务器端和客户端的配置文件，然后可以将其用于Linux客户端；也可以生成二维码，用手机客户端扫描；
前面这些安装信息，在电脑上复制粘贴输入到客户端是可行的；
Linux机器，可以用v2ray官网的Linux命令行客户端，按照上述配置，自己手工写配置文件，更好的是利用上述Windows客户端已经输入过的服务器配置，生成一个配置文件拿到Linux上用；
或者是使用v2ray配置生成器生成一份基本配置使用；
更好的方法：内部网，或者国内类似阿里云，华为云等自己可以控制的公用机器上安一个v2ray客户端，然后对外提供代理，限于小范围使用，只要是用于编程查资料，那么就不怕什么；这样做基本一劳永逸，要改配置也不需要所有客户机器和手机等一一修改；



VPS选择：
搬瓦工：如果求快，这是首选。（https://bandwagonhost.com/）美国西部的CN2 GIA线路VPS，目前最低49美元/年；但是这个是年付，如果被墙，就很麻烦了，没法免费换IP，不如下面的其他各家销毁该机器，再新建一个；但是线路比其他家的都快；这个VPS 49美元/年的每月是1T流量；
AWS：双币信用卡注册一个AWS账号，然后其实里面的EC2和LightSail都可以用来翻墙，都是按小时计费，不行的话马上终止一台机器，新建另一台即可；不同的是，LightSail是“包月”的，每月3.5美元或者5美元，包含1T流量（但是进出流量都算，稍微有点坑，不过1T每月一个人或者两三个人合用肯定用不完所以问题不大），EC2的话，流量是9美分/GB，只算从该机出去的流量。根据我过去长期用EC2翻墙的经验，不看视频的话，最低配机器的机器运行费用2美元/月，流量费2美元/月基本4-5美元/月也就打住了；
Google GCE:各有特色，因为拿GCE翻墙的人多了产生某些不利影响，所以Google特地调整了到中国大陆方向的出口流量费用23美分/GB，很贵了。但是好处是GCE线路好，此外不容易被封，起码我的GCE弗吉尼亚节点哪怕在敏感时期也从来没被封过；此外GCE允许你免费运行一个最低配的，弗吉尼亚区域的节点，可谓作为翻墙紧急备用节点再合适不过了，其他方式被封的话，临时通过这个方式翻出去操作其他翻墙方式；此外，入口流量不收费（这是一个基本原则，各家公有云都如此，AWS LightSail是个别例外），所以还可以将其用于重要数据备份，因为上传数据到这里对该机而言是入口流量，免费；
阿里云国际：阿里云的新加坡，日本等亚洲节点也可以用来翻墙，欧美节点也可以但我没用过；注意点：建立机器时不要选“安全加固”，免得被阿里云的监控程序监测到机器上存在翻墙程序；建立后最好用网上的阿里云监控程序清理脚本清理一下机器；注意这里也有ECS（类似AWS EC2的计算节点）和“轻量级应用服务器”的区分，后者就是VPS。这两者的区别对于翻墙而言主要在于前者按量计费，流量0.8元人民币/G，大致也和AWS的9美分/G差不多，后者每月24元1T流量包月；
vultr:首家推出2.5美元/月VPS；现在一般是5美元/月，1T流量，按小时计费，如果开通了一个节点，然后ping不通，诊断一下发现被墙了，可以马上终止该节点，换区域新建一个，只消耗1小时的0.7美分运行费用；
Linode：我没用过，性能高，价格贵，用来做正常网站的首选；
机场：（商家提供的翻墙服务）JustMySocks，搬瓦工官方出品，2.88美元/月，CN2 GIA的快速线路，拥堵比较少，免得自己建立服务器的麻烦。其他小机场省心，但是跑路或者被封风险比较大；


CDN:
CDN本来的作用是加速网站访问，特别是图片，视频等各种静态资源的访问；这里我们用来在我们的翻墙服务器之前加一道保护，防止GFW找到我们的真实IP；如果真实IP被墙而又买的是搬瓦工之类年付的VPS的话，还可以利用这个救活被墙IP；
一般用的都是CloudFlare，对于免费用户，一天1T流量以内肯定是没问题的（注意这里是一天1T，前面说了一个月1T都是用不完的）。
使用cdn的话，按照教程把自己域名的域名解析服务器指定到cdn这里，然后创建一个二级域名指向自己的VPS；
此处注意：前面的自动脚本安装过程中，需要二级域名解析出来的IP和本机IP相同才能正常自动申请TLS证书，而CDN默认操作是把域名解析到自己的节点IP去的，肯定不符合，所以自动脚本执行过程中，在CDN这里暂不开启CDN功能，只是直接解析到真实IP，安装完成后再开启CDN功能；
还有注意：CDN只能对80和443端口加速，所以前面v2ray必须配置到443端口；
如果不用CDN，前面的自动脚本也是可用的，域名直接指向IP，就没这个小问题；
对翻墙而言，CDN的主要作用是隐藏真实VPS IP，防止GFW找到；原理是我访问的CDN的某个IP，CDN再去后台我的真实IP那里取数据，GFW只看到我访问CDN了，而且有TLS保护，GFW不知道我实际干了什么；而CDN和各大公有云的IP一样，是主流商用网络基础设施，GFW不敢全面或者长期封锁，投鼠忌器。
由前面的主要作用，次要作用是救活被墙IP，例如6月初被墙的搬瓦工IP，就通过这方式救活了。
至于CDN本来的作用：加速，根据地区和运营商不同，可能是加速，也可能减速。至少延迟肯定是明显增加的。但是在公司电信线路上，通过CDN以后，下载速度大大增加了。在其他线路上，CDN起码是可用，哪怕IP被墙了，也还可用，速度和延迟往往就不太好了；

VPS安全保护：
为了防止GFW的探测是不是翻墙服务器，有必要限制可以访问VPS的IP；一般应该把自己家里，公司，手机等常用网段的IP都允许，然后把CDN的IP也都允许，其他IP都禁止；
得知自己IP的方法：电脑或者手机，浏览器打开ip.taobao.com，左下角就会给出自己的IP；
然后拿着这个IP去APNIC查一下这是哪个IP段，把这个IP段加入防火墙的允许列表；
防火墙使用Linux自带的iptables，为了简单，Ubuntu上有一个包装工具叫ufw，可以简化操作；
命令行类似如下：
允许单个端口被全世界访问，一般用于类似http服务器，或者翻墙服务器之类端口
ufw allow 23456
允许单个IP访问本机所有端口，一般用于类似公司网络出口IP是固定的场合，方便自己在公司时的操作
ufw allow from 66.77.88.99 to any
允许某一个IP段对本机的所有访问，这个谨慎使用，用于家庭宽带等IP不固定的场合。一般家庭宽带IP段都会在某一个B类段内部跳动，所以/16一般就够了；有时候运营商的IP池子比较大，可能会在32或者64个B类段里面跳动，那就每次允许一个/16的B类段，一般估计添加三五个B类段就够了；
ufw allow from 219.142.0.0/16 to any
以下几条是禁止VPS本机访问外部端口，主要用途是防止VPS因故被人当作垃圾邮件发送服务器。因为SMTP等服务器的端口都是固定的，所以这几条基本够了；这种情况发生过，我当时使用一个来源不明的“一键安装脚本”，被人夹带私货，成了垃圾邮件发送服务器，还因此被VPS服务商搬瓦工停机处罚。
ufw deny out 25
ufw deny out 110
ufw deny out 143
ufw deny out 465
ufw deny out 587
ufw deny out 993
ufw deny out 995

多终端
v2ray的客户端，Wondows x64/x86,Linux x64/x86/arm,FreeBSD等都有，找找就有；
手机客户端：安卓：Google Play有好几个，如果手机暂未配置翻墙，可以通过ApkDownloader等方法下载后通过USB数据线复制到手机后安装，无需ROOT；
苹果：从17年开始苹果公司就按照中国有关部门要求，把AppStore中国区的所有VPN应用都下架了，所以除非你的iOS设备越狱了，或者你有美国区的apple ID，否则是没法翻墙了；

分流
无论是电脑还是手机，我们日常还是要访问很多国内网站的，所以如果不分流，则会面临访问国内网站很慢的问题，要避免的话则要翻墙时临时开启，用完马上关掉，非常麻烦；所以有必要分流；
chrome有个SwitchyOmega插件，可以做到自动分流，只对GFWList(被墙网站列表）上的网站去走翻墙代理，其余网站不走代理，正常访问；Firefox也有对应插件可以做到类似效果，具体我不知道；
v2ray的客户端特别是Windows客户端一般也有类似分流功能，有GFWList支持，准确区分哪些网站需要走翻墙通道；再不济也有“绕过局域网和国内IP”的选项，只把国外IP走翻墙通道，这样访问国内网站的速度也保证了，翻墙流量节省也做到了。（其实只有在使用EC2这样流量按量计费的场合才需要节约流量）。
避开热门区域：在敏感时期，日本，美国，香港，新加坡，台湾等区域的VPS IP容易被封，此时避开这些区域，使用冷门区域例如加拿大，英国，法国，德国等区域的节点一般没事；我在6月初就是靠了vultr法兰克福的节点救急的；

无代理的应用：proxifier。有些应用没有提供代理服务器设置，此时可以用Proxifier这个Windows软件来强制这些应用走代理通道。该软件是收费软件，不过能找到注册码；如果是在Linux上，一般都会有一个环境变量设置代理就能起作用；如果还不起作用那么还可以用iptables来做到这一点；

风险点：
一键部署脚本作者可能会被喝茶，被迫删除该库，所以自己git clone一份比较稳妥；
CDN，特别是国外的CDN，国内会时不时因为各种原因封其一部分IP；
防止阿里云监控自己的机器上有翻墙程序；有人中招过；
GFW的技术进步，现在加密方式里安全的只有带有AEAD的算法了，各种类似aes-256-gcm的算法推荐，带GCM结尾的AEAD算法推荐使用，其他算法不推荐使用了；

最后切记：哪怕通过以上途径翻墙出去了，在twitter，facebook等国外社交网络，也不要发表反动言论，包括任何抱怨政府，体制，官员等等的言论。如今跨省追捕能力已经延伸到全世界了。翻墙出去不等于匿名。要达到匿名如同斯诺登或者阿桑奇那个效果，需要相当高级的IT和社会工程学等各方面的全面技能，不是一般人能做到的。因此吃亏的，在墙外社交网站乱说，人在墙内的，已经被抓了很多了。